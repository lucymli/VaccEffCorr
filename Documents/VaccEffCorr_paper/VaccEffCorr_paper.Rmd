---
title: 
  - "Estimating correlates of protection and vaccine effect simultaneously"
  - "\textbf{Short title:}Estimating vaccine efficacy using serotype-specific antibody titers"
author: 
  - "Lucy M Li$^{1}$^[Corresponding author: Lucy Li, <luli@hsph.harvard.edu>], Marc Lipsitch$^1$"
  - "$^1$Center for Communicable Disease Dynamics, Harvard T.H. Chan School of Public Health, Boston, Massachusetts, United States of America"
date: '`r Sys.Date()`'
output: 
  pdf_document:
    fig_caption: yes
bibliography: ../../../../../library.bib
csl: plos-computational-biology.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message = FALSE, warning=FALSE, cache=FALSE)
library(ggplot2)
library(grid)
library(gridExtra)
library(coda)
library(dplyr)
library(magrittr)
source("../../Code/functions.R")
load("../../Code/parse_output_20170403.RData") # results
```

\begin{center}
\textbf{Abstract}

Abstract text %300 words. no subsections

\textbf{Author Summary}

Author Summary text % 150-200 word non-technical summary

\end{center}


# Introduction

\emph{Streptococcus pneumoniae} are gram-positive bacteria that can cause a number of serious illnesses including pneumonia, which is the leading cause of child mortality. While nasopharyngeal (NP) carriage does not usually lead to symptomatic infection, it serves as a precursor to disease and a potential source of transmission. Pneumococcal conjugate vaccines (PCV) were developed to target the capsid polysaccharides and reduce the rate of acquiring \emph{S. pneumoniae}. Currently, the vaccine contains the capsular polysaccharide antigen from the 13 serotypes that cause the majority of serious disease. 

When the 13-valent PCV (PCV13) was first introduced, a vaccine trial was held in Israel to determine the effectiveness of PCV13 compared to the existing 7-valent PCV (PCV7) [@Dagan2013]. The endpoint of the trial was NP carriage after vaccination. However, many colonization events were yet to occur by the end of the two-year trial. This highlights a general difficulty in assessing vaccine efficacy as the clinical endpoint might not be observable for a long time.

There are many immunological biomarkers that correlate with the clinical endpoint of interest. Those that lie on the causal pathway are known as surrogates of protection. Identifying surrogates of protection and quantifying the relationship with the clinical endpoint would help to assess vaccine effectiveness without waiting a long time to observe clinical endpoints of interest. For some vaccines, complete protected once a threshold level of antibody titer is induced, for example diphtheria, rubella, measles, and tetanus. In the case of PCV, the level of protection correlates with antibody titer but even a high antibody concentration does not guarantee protection against infection. The concentration of vaccine-induced IgG against a particular serotype has been shown to correlate with the rate of acquiring that serotype [@Dagan2016]. Quantifying the relationship between antibody titer and protection against colonization is therefore needed to predict the vaccine efficacy based on antibody levels.

Here, we present an inference framework that co-estimates vaccine efficacy for a multivalent vaccine while quantifying the relationship between vaccine-induced antibody concentrations and the rates of NP colonization. In addition to testing on simulated data, we applied this inference framework to vaccine trial data from [@Dagan2013].


# Methods

<!-- Please clarify the reasons for including your Materials and Methods section before the Results or Discussion sections in your cover letter when submitting your manuscript files-->

## Data

In the trial in Israel, participants were recruited at the age of 2 months and were randomized to receive either PCV7 or PCV13 [@Dagan2013].  Participants of the trial made 8 visits in total at 2, 4, 6, 7, 12, 13, 18, and 24 months of age. A nasopharyngeal swab was taken from each participant at each of the 8 visits to determine the serotype(s) of \emph{S. pneumoniae} colonizing the nasopharynx. Three doses of PCV were given at 2-, 4-, and 6-month visits, and a booster dose at 12-month visit. Blood samples were taken at the 7- and 13-month visits, one month after the infant series and the booster dose, respectively. The serum concentrations of IgG against vaccine serotypes were measured using the blood samples.

## Model structure

We modeled \emph{S. pneumoniae} colonization of the nasopharynx as a Markov process with $J+1$ states, where $J$ is the number of serotypes (Figure \ref{fig:model}). Individuals are either uncolonized, or colonized by serotype $j\in \{1,...,J\}$. Let $X_{i}(t)$ be the colonization status of individual $i$ at time $t$, where $X_{i}(t)=0$ means the individual is uncolonized, and $X_{i}(t)=j$ means the individual is colonized by serotype $j$. In a unvaccinated population, the serotype-specific rates of colonization and clearance are $\lambda_j$ and $\mu_j$, respectively. For simplicity, we assume that no co-infections or super-infections. If an individual is currently infected by serotype $m$, the rate of being displaced by serotype $j$ is $k_m \lambda_j$ where $k_m$ is the relative rate of being displaced by another serotype when an individual is currently infected by serotype $m$. The parameters of such a model can be estimated from prevalence data that include the colonization status of the each individual at discrete time points [@Mehtala2016].

Vaccination reduces the rate of acquisition of serotypes targeted by the vaccine, and the magnitude of reduction is proportional to the vaccine-induced antibody level as quantified by the serum titer of serotype-specific IgG ($\mu$g/mL) after vaccination. Let the average rate of acquiring serotype $j$ amongst vaccinated individuals $i\in \{1,...,N\}$ be $\lambda'_j = \frac{1}{N}\sum\limits_{i=1}^{N}\lambda'_{ij}$, where $N$ is the number of individuals. The serotype-specific antibody level against serotype $j$ in individual $i$ is $A_{ij}$, with the average antibody level in that individual being $\textrm{log}10(A_{i}) = \sum\limits_{i=1}^{N}\textrm{log}10(A_{ij})$.

We tested 3 models relating the vaccine-induced antibody levels is related to the reduction in acquisition rates:

1. Reduction in serotype-specific acquisition rate is predicted by serotype-specific antibody levels. The relationship is serotype-specific. $\lambda'_{ij} = f_j(A_{ij})\lambda_j$
2. Reduction in serotype-specific acquisition rate is predicted by serotype-specific antibody levels. The relationship is the same for all serotypes. $\lambda'_{ij} = f(A_j)\lambda_j$
3. Reduction in serotype-specific acquisition rate is predicted by average antibody levels. The relationship is serotype-specific. $\lambda'_{ij} = f_j(A_i)\lambda_j$

If model 2 were true, then we would expect more colonizations by serotypes against which the vaccine-induced IgG concentrations were low. 

Model 3 could perform better than than first two models if the error in IgG titer measurement is high.


```{r MarkovTransitionModel, fig.align="center", out.width="300px", fig.cap=paste0("\\label{fig:model}Markov transition model of transmission process without vaccination.")}
knitr::include_graphics("MarkovModel.pdf")
```


In all cases, we modeled the relationship $f(\cdot)$ as a linear function with the form $a + bA$. The number of $a$ and $b$ parameters that needs to be estimated depends on the hypothesis.

## Inference

Let the vector of parameters to be estimated be $\theta=\{\lambda,\mu,k,a,b\}$, where $\lambda=\{\lambda_1,...,\lambda_J\}$, $\mu=\{\mu_1,...,\mu_J\}$, and $k=\{k_1,...,k_J\}$. The posterior density of interest is $P(\theta | X) \propto P(\theta) P(X| \theta)$, where $P(\theta)$ is the prior distribution of parameter values and $P(X| \theta)$ is the likelihood.

The likelihood is sequentially calculated for time steps $t_0, t_1,...,t_W$, where $W$ is the number of observations after the initial observation.

$P(X|\theta) = P(X(t_0)|\theta) \sum\limits_{u=1}^{W}P(X(t_u)|X(t_{u-1}))$

Each of the probabilities can be calculated from the transition rate matrix. Each element of the transition rate matrix for individual $i$ at time $t$ describes the rate of transitioning from state $l$ to state $m$, where $l$ is the row index and $m$ is the column index. The transition matrix at time $t$ for individual $i$ is given below (index $i$ is dropped from $M$ and $\lambda$ terms for simplicity):

$$
M(t) =
\left[\begin{array}{ccccc}
  {- \sum\limits_{j=1}^J} \lambda'_j & \lambda'_1 & ... & ... & \lambda'_J \\
  \mu_1 & -\mu_1 -k_1\sum\limits_{j\neq 1}^J \lambda'_j & k_1\lambda'_2 & ... & k_1\lambda'_J \\
  \vdots & \vdots & \vdots & \vdots & \vdots \\
  \mu_J & k_J \lambda'_1 & k_J \lambda'_2 & ... & -\mu_J -k_J\sum\limits_{j\neq J}^J \lambda'_j
\end{array}\right] .
$$

The equilibrium transition probabilities can be calculated using $G(t_0)=exp(10000\times M(t_0))$, where 10,000 is an arbitrary large number. The calculate the probability of an individual being in state $X(t_0)$ at the start of the observation period is therefore $P(X(t_0)|\theta)=G_{0,X(t_0)}$. Similarly, probabilities of observing subsequent states can be calculated by first exponentiating the rate matrix $G(t_i)=exp((t_i-t_{i-1})\times M(t_i))$, and then using the value $P(X(t_i)|X(t_{i-1}))=G_{X(t_{i-1}),X(t_i)}(t_i)$.


We estimated the posterior distribution of parameter values using a Markov Chain Monte Carlo (MCMC) approach. The value of only one parameter was changed at each MCMC iteration. The new parameter vector $\theta'$ was accepted or rejected with probability $\frac{P(\theta|\theta')P(\theta')P(D|\theta')}{P(\theta'|\theta)P(\theta)P(D|\theta)}$.

Code used to estimate parameters is available at github.com/lucymli/VaccEffCorr/tree/openmp/Code/VaccInfer/VaccInfer.

# Results

```{r results_all_sero}
which.PCV13.consistently.reduce <- which(sapply(lapply(PCV13.all.serotypes$rates, `[[`, "summary"), `[`, 3, 2)<=0)
PCV13.consistently.reduce <- EpiGenR::str_to_sentence(pcv13.types[which.PCV13.consistently.reduce])
PCV13.reduce.halves <- combined.data$PCV13$abdata %>% apply(2, quantile, c(0, 0.5))
PCV13.reduce.percent <- sapply(seq_along(1:13), function (i) {
  #10^(PCV13.reduce.halves[, i])
  get.ab.lambda.reduction(c(0.35, 10^(mean(combined.data$PCV13$abdata))), PCV13.all.serotypes$MCMC, i, pcv13.types, as.percent=TRUE) %>% EpiGenR::values_ci_to_str()
})
which.PCV7.consistently.reduce <- which(sapply(lapply(PCV7.all.serotypes$rates, `[[`, "summary"), `[`, 3, 2)<0)
PCV7.consistently.reduce <- EpiGenR::str_to_sentence(pcv13.types[which.PCV7.consistently.reduce])
PCV7.reduce.halves <- combined.data$PCV7$abdata %>% apply(2, quantile, c(0, 0.5))
PCV7.reduce.percent <- sapply(1:7, function (i) {
  get.ab.lambda.reduction(c(0.35, 10^(mean(combined.data$PCV7$abdata))), PCV7.all.serotypes$MCMC, i, pcv13.types[i], as.percent=TRUE) %>% EpiGenR::values_ci_to_str()
})
```

## Predictiveness of protection against colonization using serotype-specific antibody levels

In the case of all serotypes for both PCV13 and PCV7 recipients, increased vaccine-induced IgG concentration against a serotype was associated with reduced rate of acquiring that serotype. However, the credible intervals around the association was wide for most serotypes. The negative association was only certain for serotypes `r PCV13.consistently.reduce` among PCV13 recipients, and for serotypes `r PCV7.consistently.reduce` among PCV7 recipients. 

Among PCV13 recipients, increasing the IgG concentrations against serotypes `r PCV13.consistently.reduce` from 0.35 to `r round(10^(mean(combined.data$PCV13$abdata)), 2)` was associated with reductions in acquisition rates of `r EpiGenR::str_to_sentence(PCV13.reduce.percent[which.PCV13.consistently.reduce])`, respectively. Among PCV7 recipients, increasing the IgG concentrations against serotypes `r PCV7.consistently.reduce` from 0.35 to `r round(10^(mean(combined.data$PCV7$abdata)), 2)` was associated with reductions in acquisition rates of `r EpiGenR::str_to_sentence(PCV7.reduce.percent[which.PCV7.consistently.reduce])`, respectively. 

```{r outputPCV13, fig.width=9, fig.height=6.25, fig.cap=paste0("\\label{fig:PCV13_all} Reduction in rates of acquiring PCV13 serotypes as a function of serotype-specific IgG concentrations after vaccination. The three models refer to models relating antibody levels to protection against colonization, as described in the Methods section. The 95% highest posterior density intervals around estimates of acquisition rates are shown as shaded areas.")}
#grid.arrange(PCV13.all.plot1, PCV13.all.plot2+theme(legend.position="none"))
print(PCV13.all.plot)
```




```{r outputPCV7, fig.width=9, fig.height=3.75, fig.cap=paste0("\\label{fig:PCV7_all} Reduction in rates of acquiring PCV7 serotypes as a function of serotype-specific IgG concentrations after vaccination. The three models refer to models relating antibody levels to protection against colonization, as described in the Methods section. The 95% highest posterior density intervals around estimates of acquisition rates are shown as shaded areas.")}
print(PCV7.all.plot)
```

## Comparison with separate estimation of vaccine effects, and relationship between antibody levels and protection against colonization


## Using mean antibody level vs serotype-specific antibody levels

```{r results_mean_ab}
which.PCV13.meanab.consistently.reduce <- which(sapply(lapply(PCV13.meanab$rates, `[[`, "summary"), `[`, 3, 2)<=0)
PCV13.meanab.consistently.reduce <- EpiGenR::str_to_sentence(pcv13.types[which.PCV13.meanab.consistently.reduce])
PCV13.meanab.reduce.percent <- sapply(seq_along(1:13), function (i) {
  #10^(PCV13.reduce.halves[, i])
  get.ab.lambda.reduction(c(0.35, 10^(mean(combined.data$PCV13$abdata))), PCV13.meanab$MCMC, i, pcv13.types, as.percent=TRUE) %>% EpiGenR::values_ci_to_str()
})
which.PCV7.meanab.consistently.reduce <- which(sapply(lapply(PCV7.meanab$rates, `[[`, "summary"), `[`, 3, 2)<0)
PCV7.meanab.consistently.reduce <- EpiGenR::str_to_sentence(pcv13.types[which.PCV7.meanab.consistently.reduce])
PCV7.meanab.reduce.percent <- sapply(1:7, function (i) {
  get.ab.lambda.reduction(c(0.35, 10^(mean(combined.data$PCV7$abdata))), PCV7.meanab$MCMC, i, pcv13.types[i], as.percent=TRUE) %>% EpiGenR::values_ci_to_str()
})
```

Among PCV13 recipients, increasing the geometric mean of IgG concentrations against all serotypes from 0.35 to `r round(10^(mean(combined.data$PCV13$abdata)), 2)` was associated with reductions in acquisition rates of `r EpiGenR::str_to_sentence(PCV13.meanab.reduce.percent[which.PCV13.consistently.reduce])` and serotypes `r PCV13.meanab.consistently.reduce`, respectively. Among PCV7 recipients, increasing the geometric mean of IgG concentrations against all serotypes from 0.35 to `r round(10^(mean(combined.data$PCV7$abdata)), 2)` was associated with reductions in acquisition rates of `r EpiGenR::str_to_sentence(PCV7.meanab.reduce.percent[which.PCV7.meanab.consistently.reduce])` for serotype `r PCV7.meanab.consistently.reduce`. 


## PCV7 vs PCV13 rates of colonization

```{r VaccEff}
reduction.in.rates <- apply(colonization.reductions[, -1], 1, function (x) scales::percent(x)%>%EpiGenR::values_ci_to_str())
```

For the 6 new serotypes in PCV13, reduced rates of acquisition in PCV13 recipients compared to PCV7 recipients were identified for `r EpiGenR::str_to_sentence(pcv13.types[-1:-7][substr(reduction.in.rates,1,1)!="-"])` with reductions in acquisition rates of `r EpiGenR::str_to_sentence(reduction.in.rates[substr(reduction.in.rates,1,1)!="-"])`, respectively.

# Discussion

The immune response induced by vaccination is usually quantified by antibody titers because in the case of most vaccines, protection against infection is correlated with higher titers of specific antibodies [@Plotkin2010]. Given recent technological advances, it is now possible to measure other aspects of the immune response as well such as antibody affinity and function. Potentially thousands of biomarkers could be measured in the future. Identifying surrogates amongst correlates of protection is important to accurately predictive vaccine efficacy.

Previous work has dealt with some aspects of the problem. Without considering the immune response, Mehtala et al. [-@Mehtala2016] have looked at the multiple-serotype estimation of vaccine efficacy, a framework on which we would build [@Mehtala2016]. Dagan et al. [-@Dagan2016] correlated serotype-specific IgG titer with predicted rates of acquisition. The work presented here integrates the processes of vaccine efficacy estimation and analysis of correlates of protection.










<!-- I believe this model captures a general feature of  many data sets that will be arising during vaccine trials. We have an outcome measure, a high-dimensional (here 12, but in the future 1000s [@Hagan2015]) list of immune correlates of that outcome measure, probably only a small number of which are surrogates. The unique thing about this data set is that we have a strong biological reason to think that there is only one surrogate for protection, and a lot of correlates that are not surrogates. The specific question here is to model the system we have in front of us, but the more general motivation is to develop approaches for identifying real surrogates statistically. -->

<!-- Previous work has dealt with some aspects of the problem. Without considering the immune response, Mehtala et al. [-@Mehtala2016] have looked at the multiple-serotype estimation of vaccine efficacy, a framework on which we would build [@Mehtala2016]. Dagan et al. [@Dagan2005] have shown that serotype-specific antibody measurements correlate with vaccine-induced protection against that serotype [@Dagan2005], and a new analyss showing the same thing in another dataset is in press. We (poster presentation ISPPD 2016) showed strong correlations among the immune responses to different serotypes in vaccinated individuals. The new work to be done would be: -->

<!-- 1. Set up an inference framework that generalizes [@Mehtala2016] to include simultaneous inference of the vaccine efficacy distribution and the impact of serotype-specific vaccine immunogenicity on vaccine efficacy -->
<!-- 2. Compare this estimation to the separate estimation of serotype-specific VE [@Mehtala2016] and predictors of VE [@Dagan2005]. Does this improve efficiency or reduce bias for either of the estimands? In particular the approach of [@Dagan2005] probably underestimates the magnitude of the correlation between serotype-specific immune response Rj and serotype-specific efficacy because serotype-specific response Rj is positively correlated with other serotype-specific responses Rk, which are negatively correlated with hazards Fk, which compete with the outcome C=j – thus people who have strong immune responses are more protected against all serotypes, but since the serotypes are competing risks the effect of immune response on any individual serotype will be attenuated by correlated effects on competing serotypes. -->

<!-- 3.	Assess whether the inference method can “tell” that serotype-specific measurements are surrogates while other serotype-specific responses are only correlates -->
<!-- 4.	Assess whether (due to measurement error) a summary of all-serotype responses is more predictive of protection than is serotype-specific response (because the former has less measurement error). -->
<!-- 5.	Consider ways to generalize this to other ways of measuring the outcome (directly measuring hazard or risk, vs. this complex outcome that is a composite due to competition between the serotypes) -->





<!-- ## Data -->

<!-- A vaccine trial with vaccination vs J different serotypes (J-valent vaccine) randomized, antibodies measured and then followup to see which if any serotype colonizes the person. -->

<!-- ## Simulations -->

<!-- How does the proportion of fully protected individuals affect nasopharyngeal carriage of vaccine and non-vaccine -->
<!-- S. pneumoniae types? -->

```{r p0simulations, fig.width=10, fig.height=6, eval=FALSE}
load(file="../../Code/sim.data.RData")
sims.vary.p0.max <- 3
set.seed(2100)
sims.vary.p0 <- lapply(1:sims.vary.p0.max, function (x) {
  sim.params$p0 <- sim.params$p0/max(sim.params$p0) * x/sims.vary.p0.max
  sim.data <- do.call(simulate_data, sim.params)
  return (sim.data)
})
sims.vary.p0.plots <- lapply(1:length(sims.vary.p0), function (i) {
  plot_timeseries(sims.vary.p0[[i]], sim.params$ntypes) +
    ggtitle(paste0("mean p0: ", round(mean(sim.params$p0/max(sim.params$p0) * i/sims.vary.p0.max), 2))) +
    theme(legend.position="top")
})
sims.vary.p0.legend <- EpiGenR::extract_gglegend(sims.vary.p0.plots[[1]])
sims.vary.p0.plots <- lapply(sims.vary.p0.plots, function (x) x+theme(legend.position="none"))
sims.vary.p0.plots$legend <- sims.vary.p0.legend
sims.vary.p0.plot.all <- arrangeGrob(grobs=sims.vary.p0.plots, ncol=sims.vary.p0.max, heights=c(8.5, 1.5))
grid.draw(sims.vary.p0.plot.all)
```




```{r ab_correlations, fig.width=6, fig.height=6, eval=FALSE}
GGally::ggpairs(data.frame(sim.data$abdata), colour="blue") + theme_bw()
```

<!-- ## Model -->

<!-- For each participant i there is a vaccine status $V_i$ (0/1), a set of immune responses $R_{ij}$ (antibodies to serotype j), a "hazard of colonization" $F_{ij}$ (nonnegative) and an outcome which is the serotype (if any) with which the individual is colonized at some follow up time (there may be more than one followup time, but we ignore that here). There is also a patient-specific "immune responsiveness" $X_i$  that affects the immune response to all serotypes. -->

<!-- ![Causal Diagram](../../Figures/CausalDiagram.png) -->

<!-- Importantly, the only direct causal arrows from the immune response R to the outcomes hazard F are serotype-specific: antibody to one serotype can suppress risk of acquieing that serotype, but not of other serotypes (by assumption, very likely true). The colonization state of the individual at followup may be modeled by a competing risk model: or perhaps better by the model in the paper by Mehtala et al. [-@Mehtala2016].   -->

<!-- If this model is true, then we have a surrogate of protection (the serotype-specific antibody measurement for each serotype specific hazard and we observe the colonization status which informs us about these hazards. We also have a number of correlates of protection, which are not causal for hazard but may be correlated with it because of their common cause Xi, the subject’s immune responsiveness (we have analyzed just the $R_{ij}$ and seen that responses are very positively correlated across serotypes within an individual). -->


### Acknowledgements

### Funding statement

This work was funded by MIDAS.

### Competing interests


# References
